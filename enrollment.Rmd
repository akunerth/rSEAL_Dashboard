---
title: "Current Enrollment"
author: 
date: "Last Updated: 1/20/2021"
output: 
  html_document:
    theme: flatly
    toc: TRUE
---

```{r load-packages, echo=FALSE, warning=FALSE, include=FALSE, cache=FALSE}

library(magrittr)
library(codified)
library(rlang)
library(epiDisplay)
library(tibble)
library(tidyr)
library(checkmate)
library(testthat)
library(cowplot)
library(readxl)
library(knitr)
library(formattable)
library(ggpubr)
library(frequency)
library(plotly)
library(emmeans)
library(kableExtra)
library(papaja)
library(kableExtra)
library(dplyr)
library(RColorBrewer)
library(tidyverse)
library(ggformula)
library(lubridate)
library(plyr)
library(readr)
library(dplyr)
library(haven)
library(RColorBrewer)
library(ggplot2)
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)
library(reshape2)
library(skimr)
library(here)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format = "html", knitr.kable.NA = '') 
```


```{r Read in Files and set-up columns, echo = FALSE, warning=FALSE, message=FALSE}
#Read Masterfile
library(haven)
masterfile <- data.frame(read_sav(file = '~/Dropbox (University of Oregon)/SEAL R01/_Remote SEAL/rSEAL_Data/masterfile.sav'))

masterfile$rSEAL.C1.LDL.003[masterfile$rSEAL.C1.LDL.003 == ""] <- NA
masterfile$rSEAL.C1.LDL.029[masterfile$rSEAL.C1.LDL.029 == ""] <- NA
masterfile$rSEAL.C2.LDL.003[masterfile$rSEAL.C2.LDL.003 == ""] <- NA
masterfile$rSEAL.C2.LDL.029[masterfile$rSEAL.C2.LDL.029 == ""] <- NA

#Create new DataFrame for Enrollment Table

Enrollment <- data.frame("RSID" = masterfile$RSID,
                        "SubInfoActual"=masterfile$SubInfoStart,
                         "Survey1Actual"=masterfile$Survey1Start,
                         "Survey2Actual"=masterfile$Survey2Start,
                         "PDR2Actual"=masterfile$PDR2Start,
                         "PDR3Actual"=masterfile$PDR3Start,
                         "LENAD1DiaryActual"=masterfile$rSEAL.C1.LDL.003,
                         "LENAD2DiaryActual"=masterfile$rSEAL.C1.LDL.029)

```


<center>
**Wave 1 Participant Completion **  
This chart shows the combination of completions for the dyads across Wave 1.  
<center>

```{r SEAL Wave Progression, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))

# Format dates

masterfile$Survey1Start <- as.Date(masterfile$Survey1Start, "%Y/%m/%d")
masterfile$Survey2Start <- as.Date(masterfile$Survey2Start, "%Y/%m/%d")
masterfile$PDR2Start <- as.Date(masterfile$PDR2Start, "%Y/%m/%d")
masterfile$PDR3Start <- as.Date(masterfile$PDR3Start, "%Y/%m/%d")
#masterfile$rSEAL.C1.LDL.003 <- as.Date(masterfile$rSEAL.C1.LDL.003, "%Y/%m/%d")
#masterfile$rSEAL.C1.LDL.029 <- as.Date(masterfile$rSEAL.C1.LDL.029, "%Y/%m/%d")

#Classify Tests
Survey1Completion <- masterfile$Survey1Completion <- ifelse(masterfile$Survey1Start > "2020-07-01", "Complete", "Incomplete")
Survey2Completion <- masterfile$Survey2Completion <- ifelse(masterfile$Survey2Start > "2020-07-01", "Complete", "Incomplete")
PDR2Completion <- masterfile$PDR2Completion <- ifelse(masterfile$PDR2Start > "2020-07-01", "Complete", "Incomplete")
PDR3Completion <- masterfile$PDR3Completion<- ifelse(masterfile$PDR3Start > "2020-07-01", "Complete", "Incomplete")
LENAD1DiaryCompletion <- masterfile$LENAD1DiaryCompletion <- ifelse(masterfile$rSEAL.C1.LDL.003 > "2020-07-01", "Complete", "Incomplete")
LENAD2DiaryCompletion <- masterfile$LENAD2DiaryCompletion<- ifelse(masterfile$rSEAL.C1.LDL.029 > "2020-07-01", "Complete", "Incomplete")

Wave1_Progression <- masterfile %>%
  dplyr::mutate(month = format(Survey1Start, "%m")) %>%
  dplyr::group_by(Survey1Completion, Survey2Completion, PDR2Completion, PDR3Completion, LENAD1DiaryCompletion, LENAD2DiaryCompletion) %>%
  dplyr::summarize(Count = n())
 
  kable(Wave1_Progression,
        col.names = c("Survey 1","Survey 2","PDR 2", "PDR 3", "LENA D1 Diary", "LENA D2 Diary", "Number Complete")) %>%
        kable_minimal()
```


```{r SEAL Test Counts 1, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))

#Counts of Variables
Survey1Start <- as.character(masterfile$Survey1Start)
Survey1Delinquent <- sum(is.na(masterfile$Survey1Start))
Survey1Complete <- length(Survey1Start) - Survey1Delinquent

Survey2Start <- as.character(masterfile$Survey2Start)
Survey2Delinquent <- sum(is.na(masterfile$Survey2Start))
Survey2Complete <- length(Survey2Start) - Survey2Delinquent

PDR2Start <- as.character(masterfile$PDR2Start)
PDR2Delinquent <- sum(is.na(masterfile$PDR2Start))
PDR2Complete <- length(PDR2Start) - Survey2Delinquent

PDR3Start <- as.character(masterfile$PDR3Start)
PDR3Delinquent <- sum(is.na(masterfile$PDR3Start))
PDR3Complete <- length(PDR3Start) - PDR3Delinquent

LENAD1Start <- as.character(masterfile$rSEAL.C1.LDL.003)
LENAD1Delinquent <- sum(is.na(masterfile$rSEAL.C1.LDL.003))
LENAD1Complete <- length(LENAD1Start) - LENAD1Delinquent

LENAD2Start <- as.character(masterfile$rSEAL.C1.LDL.029)
LENAD2Delinquent <- sum(is.na(masterfile$rSEAL.C1.LDL.029))
LENAD2Complete <- length(LENAD2Start) - LENAD2Delinquent


# Create data
data <- data.frame(
  Wave1=c("Survey 1","Survey 2","PDR 2","PDR 3","LENA Day 1 Diary", "LENA Day 2 Diary") ,  
  value=c(Survey1Complete,Survey2Complete,PDR2Complete,PDR3Complete,LENAD1Complete, LENAD2Complete)
  )

tbl <- kbl(data, col.names = c("Wave1","Counts")) %>%
  kable_styling( bootstrap_options = "striped", full_width = F, position = "float_left", font_size = 16)

```
<center>
**Wave 1 Participant Progression **  
This chart shows the number of participants complete with each survey instrument across Wave 1. Delinquent in this case is currently defined as being greater than 14 days from when they completed a subjectinfo form, and no completion record for the given instrument. This does not currently capture those who have dropped out (but can/will), but is set-up to show when a participant is within 7 days and 7-14 days from when the subject info was offered. We can also set up specific ranges by instrument for delayed or delinquent statuses.   
<center>
::: {}
```{r SEAL Wave 1 Progression, echo = FALSE, fig.width=10, fig.height=4, message=FALSE, warning=FALSE}

Enrollment$Surv1CompletionTime<- round(difftime(Enrollment$Survey1Actual,Enrollment$SubInfoActual, units = c("days"),1))
today <- Sys.time()
start <- as.Date("2020-07-01")
Test <- today - Enrollment$SubInfoActual

Enrollment2 <- Enrollment %>%
      select(RSID:Surv1CompletionTime) %>%
      mutate(
      Surv1Status = case_when(
      Test > 14 & is.na(Survey1Actual) ~ "Delinquent",
      Test < 7 & is.na(Survey1Actual) ~ "On-Track",
      Survey1Actual > start       ~ "Complete",
      TRUE                      ~ "Yellow"
      )
     )

Enrollment3 <- Enrollment2%>%
      select(RSID:Surv1Status) %>%
      mutate(
      Surv2Status = case_when(
      Test > 14 & is.na(Survey2Actual) ~ "Delinquent",
      Test < 7 & is.na(Survey2Actual) ~ "On-Track",
      Survey2Actual > start       ~ "Complete",
      TRUE                      ~ "Yellow"
      )
     )

Enrollment4 <- Enrollment3%>%
      select(RSID:Surv2Status) %>%
      mutate(
      PDR2Status = case_when(
      Test > 14 & is.na(PDR2Actual) ~ "Delinquent",
      Test < 7 & is.na(PDR2Actual) ~ "On-Track",
      PDR2Actual > start       ~ "Complete",
      TRUE                      ~ "Yellow"
      )
     )

Enrollment5 <- Enrollment4%>%
      select(RSID:PDR2Status) %>%
      mutate(
      PDR3Status = case_when(
      Test > 14 & is.na(PDR3Actual) ~ "Delinquent",
      Test < 7 & is.na(PDR3Actual) ~ "On-Track",
      PDR3Actual > start       ~ "Complete",
      TRUE                      ~ "Yellow"
      )
     )

Enrollment6 <- Enrollment5%>%
      select(RSID:PDR3Status) %>%
      mutate(
      LENAD1DiaryStatus = case_when(
      Test > 14 & is.na(LENAD1DiaryActual) ~ "Delinquent",
      Test < 7 & is.na(LENAD1DiaryActual) ~ "On-Track",
      LENAD1DiaryActual > start       ~ "Complete",
      TRUE                      ~ "Yellow"
      )
     )

Enrollment7 <- Enrollment6%>%
      select(RSID:LENAD1DiaryStatus) %>%
      mutate(
      LENAD2DiaryStatus = case_when(
      Test > 14 & is.na(LENAD2DiaryActual) ~ "Delinquent",
      Test < 7 & is.na(LENAD2DiaryActual) ~ "On-Track",
      LENAD2DiaryActual > start       ~ "Complete",
      TRUE                      ~ "Yellow"
      )
     )
Enrollment8 <- gather(Enrollment7, "Instrument", "Status", 10:15)

library(ggplot2) #load ggplot2 library
Enrollment8$Cases <- factor(Enrollment8$RSID) # Create a categorical variable
Enrollment8$Instrument <- factor(Enrollment8$Instrument, levels = c("Surv1Status","Surv2Status","PDR2Status","PDR3Status", "LENAD1DiaryStatus","LENAD2DiaryStatus")) # Create categorical variable
p <- ggplot(data = Enrollment8, aes(x=Instrument, fill=Status) ) + geom_bar() + # Creates stacked bar chart
scale_x_discrete(labels=c("Survey 1", "Survey 2", "PDR2", "PDR3", "LENA D1 Diary", "LENA D2 Diary")) +
scale_fill_discrete(labels = c("Complete", "Delinquent")) #Manually assigns colors
p <- p + xlab("Instrument") + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + labs(fill = "Statuses") 
 # Adds title and labels
p


```

```{r SEAL Wave 1 Progression Table, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
Wave1 <- table(Enrollment8$Instrument, Enrollment8$Status, dnn=c("Instrument", "Status"))

library(kableExtra)
rownames(Wave1) = c("Survey 1","Survey 2", "PDR 2", "PDR 3", "LENA Day 1 Diary", "LENA Day 2   Diary")
Wave1Counts <- kable(Wave1,
        col.names = c("Complete","Delinquent")) %>%
        kable_minimal()

Wave1Counts
```
:::


