
---
title: "Current Enrollment"
author: 
date: "Last Updated: 2/9/2021"
output: 
  html_document:
    theme: flatly
    toc: TRUE
---

```{r load-packages, echo=FALSE, warning=FALSE, include=FALSE, cache=FALSE}
library(magrittr)
library(codified)
library(rlang)
library(epiDisplay)
library(forcats)
library(tibble)
library(tidyr)
library(checkmate)
library(testthat)
library(cowplot)
library(readxl)
library(knitr)
library(formattable)
library(ggpubr)
library(frequency)
library(plotly)
library(emmeans)
library(kableExtra)
library(papaja)
library(kableExtra)
library(dplyr)
library(RColorBrewer)
library(tidyverse)
library(ggformula)
library(lubridate)
library(plyr)
library(readr)
library(dplyr)
library(haven)
library(RColorBrewer)
library(ggplot2)
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)
library(reshape2)
library(skimr)
library(here)
library(xlsx)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format = "html", knitr.kable.NA = '') 
```


```{r Read in Files and set-up columns, echo = FALSE, warning=FALSE, message=FALSE}

#Read Masterfile
library(haven)
masterfile <- data.frame(read_sav(file = '~/Dropbox (University of Oregon)/SEAL R01/_Remote SEAL/rSEAL_Data/masterfile.sav'))

#rSEAL Manual Consent Data
Consents1 <- data.frame(read_xlsx('~/Dropbox (University of Oregon)/SEAL R01/_Remote SEAL/rSEAL_Data/rSEAL_manual_consents.xlsx', 'Sheet1'))

#rSEAL Test Consent Data
Consents2 <- data.frame(read_xlsx('~/Dropbox (University of Oregon)/SEAL R01/_Remote SEAL/rSEAL_Data/Consent_Test.xlsx', 'Sheet1'))

#Read in LENA Tracker for Expected Dates
LENATracker <- data.frame(read.csv('~/Dropbox (University of Oregon)/SEAL R01/_Remote SEAL/rSEAL_Data/FamTracker Data/LENA_Data_w1.csv'))

#Read in Case Progression Log
CaseProg <- data.frame(read.csv('~/Dropbox (University of Oregon)/SEAL R01/_Remote SEAL/rSEAL_Data/FamTracker Data/rSEAL Case Progression Log.csv'))

#masterfile$rSEAL.C1.LDL.003[masterfile$rSEAL.C1.LDL.003 == ""] <- NA
#masterfile$rSEAL.C1.LDL.029[masterfile$rSEAL.C1.LDL.029 == ""] <- NA

#masterfile$rSEAL.C2.LDL.003[masterfile$rSEAL.C2.LDL.003 == ""] <- NA
#masterfile$rSEAL.C2.LDL.029[masterfile$rSEAL.C2.LDL.029 == ""] <- NA

#Format Dates for Consent Data
Consents2$Informed.consent <- as.Date(Consents2$Informed.consent , "%m/%d/%Y")
Consents2$Staff.Signature <- as.Date(Consents2$Staff.Signature , "%m/%d/%Y")
LENATracker$LENA1Expected <- as.Date(LENATracker$ExpectedDt1 , "%Y-%m-%d")
LENATracker$LENA2Expected <- as.Date(LENATracker$ExpectedDt2 , "%Y-%m-%d")

# Format dates
masterfile$Survey1Start <- as.Date(masterfile$Survey1Start, "%Y/%m/%d")
masterfile$Survey2Start <- as.Date(masterfile$Survey2Start, "%Y/%m/%d")
masterfile$PDR2Start <- as.Date(masterfile$PDR2Start, "%Y/%m/%d")
masterfile$PDR3Start <- as.Date(masterfile$PDR3Start, "%Y/%m/%d")
masterfile$Survey3Start <- as.Date(masterfile$Survey3Start, "%Y/%m/%d")
masterfile$Survey4Start <- as.Date(masterfile$Survey4Start, "%Y/%m/%d")
masterfile$PDR5Start <- as.Date(masterfile$PDR5Start, "%Y/%m/%d")
masterfile$PDR6Start <- as.Date(masterfile$PDR6Start, "%Y/%m/%d")
masterfile$rSEAL.C2.LDL.003 <- as.Date(masterfile$rSEAL.C2.LDL.003, "%Y-%m-%d")
masterfile$rSEAL.C2.LDL.029 <- as.Date(masterfile$rSEAL.C2.LDL.029, "%Y-%m-%d")
masterfile$rSEAL.C1.LDL.003 <- as.Date(masterfile$rSEAL.C1.LDL.003, "%Y-%m-%d")
masterfile$rSEAL.C1.LDL.029 <- as.Date(masterfile$rSEAL.C1.LDL.029, "%Y-%m-%d")
CaseProg$Q2_1_TEXT <- as.Date(CaseProg$Q2_1_TEXT,"%m/%d/%y")
CaseProg$Q2_2_TEXT <- as.Date(CaseProg$Q2_2_TEXT,"%m/%d/%y")
CaseProg$Q2_3_TEXT <- as.Date(CaseProg$Q2_3_TEXT,"%m/%d/%y")
CaseProg$Q2_4_TEXT <- as.Date(CaseProg$Q2_4_TEXT,"%m/%d/%y")                       
CaseProg$Q2_10_TEXT <- as.Date(CaseProg$Q2_10_TEXT,"%m/%d/%y")
CaseProg$Q2_11_TEXT <- as.Date(CaseProg$Q2_11_TEXT,"%m/%d/%y")
CaseProg$Q2_12_TEXT <- as.Date(CaseProg$Q2_12_TEXT,"%m/%d/%y")            
CaseProg$Q2_14_TEXT <- as.Date(CaseProg$Q2_14_TEXT,"%m/%d/%y") 
CaseProg$Q2_15_TEXT <- as.Date(CaseProg$Q2_15_TEXT,"%m/%d/%y")
CaseProg$Q2_16_TEXT <- as.Date(CaseProg$Q2_16_TEXT,"%m/%d/%y")
CaseProg$Q2_17_TEXT <- as.Date(CaseProg$Q2_17_TEXT,"%m/%d/%y")
CaseProg$Q2_18_TEXT <- as.Date(CaseProg$Q2_18_TEXT,"%m/%d/%y")            
CaseProg$Q2_19_TEXT <- as.Date(CaseProg$Q2_19_TEXT,"%m/%d/%y")      
CaseProg$Q2_20_TEXT <- as.Date(CaseProg$Q2_20_TEXT,"%m/%d/%y")                    
CaseProg$Q2_21_TEXT <- as.Date(CaseProg$Q2_21_TEXT,"%m/%d/%y") 
CaseProg$Q2_22_TEXT <- as.Date(CaseProg$Q2_22_TEXT,"%m/%d/%y")                       
CaseProg$Q2_23_TEXT <- as.Date(CaseProg$Q2_23_TEXT,"%m/%d/%y")                      
CaseProg$Q2_24_TEXT <- as.Date(CaseProg$Q2_24_TEXT,"%m/%d/%y")
CaseProg$Q9 <- as.Date(CaseProg$Q9,"%m/%d/%y")
CaseProg$Q10 <- as.Date(CaseProg$Q10,"%m/%d/%y")

#Classify Tests
SubInfoCompletion <- masterfile$SubInfoCompletion <- ifelse(masterfile$SubInfoStart > "2020-07-01", "Complete", "Incomplete")
Survey1Completion <- masterfile$Survey1Completion <- ifelse(masterfile$Survey1Start > "2020-07-01", "Complete", "Incomplete")
Survey2Completion <- masterfile$Survey2Completion <- ifelse(masterfile$Survey2Start > "2020-07-01", "Complete", "Incomplete")
PDR2Completion <- masterfile$PDR2Completion <- ifelse(masterfile$PDR2Start > "2020-07-01", "Complete", "Incomplete")
PDR3Completion <- masterfile$PDR3Completion<- ifelse(masterfile$PDR3Start > "2020-07-01", "Complete", "Incomplete")
LENAD1DiaryCompletion <- masterfile$LENAD1DiaryCompletion <- ifelse(masterfile$rSEAL.C1.LDL.003 > "2020-07-01", "Complete", "Incomplete")
LENAD2DiaryCompletion <- masterfile$LENAD2DiaryCompletion<- ifelse(masterfile$rSEAL.C1.LDL.029 > "2020-07-01", "Complete", "Incomplete")
Survey3Completion <- masterfile$Survey3Completion <- ifelse(masterfile$Survey3Start > "2020-07-01", "Complete", "Incomplete")
Survey4Completion <- masterfile$Survey4Completion <- ifelse(masterfile$Survey4Start > "2020-07-01", "Complete", "Incomplete")
PDR5Completion <- masterfile$PDR5Completion <- ifelse(masterfile$PDR5Start > "2020-07-01", "Complete", "Incomplete")
PDR6Completion <- masterfile$PDR6Completion<- ifelse(masterfile$PDR6Start > "2020-07-01", "Complete", "Incomplete")
LENAD3DiaryCompletion <- masterfile$LENAD3DiaryCompletion <- ifelse(masterfile$rSEAL.C2.LDL.003 > "2020-07-01", "Complete", "Incomplete")
LENAD4DiaryCompletion <- masterfile$LENAD4DiaryCompletion<- ifelse(masterfile$rSEAL.C2.LDL.029 > "2020-07-01", "Complete", "Incomplete")

#Create new DataFrame for Enrollment Table

Enrollment <- data.frame("RSID" = masterfile$RSID,
                        "SubInfoActual"=masterfile$SubInfoStart,
                         "Survey1Actual"=masterfile$Survey1Start,
                         "Survey2Actual"=masterfile$Survey2Start,
                         "PDR2Actual"=masterfile$PDR2Start,
                         "PDR3Actual"=masterfile$PDR3Start,
                         "LENAD1DiaryActual"=masterfile$rSEAL.C1.LDL.003,
                         "LENAD2DiaryActual"=masterfile$rSEAL.C1.LDL.029,
                         "Survey3Actual"=masterfile$Survey3Start,
                         "Survey4Actual"=masterfile$Survey4Start,
                         "PDR5Actual"=masterfile$PDR5Start,
                         "PDR6Actual"=masterfile$PDR6Start,
                         "LENAD3DiaryActual"=masterfile$rSEAL.C2.LDL.003,
                         "LENAD4DiaryActual"=masterfile$rSEAL.C2.LDL.029,
                         "SubInfoCompletion"=masterfile$SubInfoCompletion,
                         "Survey1Completion"=masterfile$Survey1Completion,
                         "Survey2Completion"=masterfile$Survey2Completion,
                         "PDR2Completion"=masterfile$PDR2Completion,
                         "PDR3Completion"=masterfile$PDR3Completion,
                         "LENAD1DiaryCompletion"=masterfile$LENAD1DiaryCompletion,
                         "LENAD2DiaryCompletion"=masterfile$LENAD2DiaryCompletion,
                         "Survey3Completion"=masterfile$Survey3Completion,
                         "Survey4Completion"=masterfile$Survey4Completion,
                         "PDR5Completion"=masterfile$PDR5Completion,
                         "PDR6Completion"=masterfile$PDR6Completion,
                         "LENAD3DiaryCompletion"=masterfile$LENAD3DiaryCompletion,
                         "LENAD4DiaryCompletion"=masterfile$LENAD4DiaryCompletion)

Consents1 <- data.frame("RSID" = Consents1$RSID,
                        "Informed Consent"= Consents1$Informed.consent, 
                        "Recontact" = Consents1$Recontact,
                        "StaffSignature"= Consents1$Staff.Signature)

Consents2 <- data.frame("RSID" = Consents2$RSID,
                        "Informed Consent"= Consents2$Informed.consent, 
                        "Recontact" = Consents2$Recontact,
                        "StaffSignature"= Consents2$Staff.Signature)

LENATracker <- data.frame("RSID" = LENATracker$RSID,
                        "LENA1Expected" = LENATracker$LENA1Expected,
                        "LENA2Expected"= LENATracker$LENA2Expected)

CaseProg <- data.frame("RSID" = CaseProg$ExternalReference,
                        "Survey1_OptOut" = CaseProg$Q2_1_TEXT,
                        "Survey2_OptOut" = CaseProg$Q2_2_TEXT,
                        "PDRW1D2_OptOut" = CaseProg$Q2_3_TEXT,
                        "PDRW1D3_OptOut" = CaseProg$Q2_4_TEXT,
                        "LENAW1D1Log_OptOut" = CaseProg$Q2_10_TEXT,
                        "LENAW1D2Log_OptOut" = CaseProg$Q2_11_TEXT,
                        "Survey3_OptOut" = CaseProg$Q2_12_TEXT,
                        "Survey4_OptOut" = CaseProg$Q2_14_TEXT,
                        "PDRW2D2_OptOut" = CaseProg$Q2_15_TEXT,
                        "PDRW2D3_OptOut" = CaseProg$Q2_16_TEXT,
                        "LENAW2D1Log_OptOut" = CaseProg$Q2_17_TEXT,
                        "LENAW2D2Log_OptOut" = CaseProg$Q2_18_TEXT,
                        "Survey5_OptOut" = CaseProg$Q2_19_TEXT,
                        "Survey6_OptOut" = CaseProg$Q2_20_TEXT,
                        "PDRW3D2_OptOut" = CaseProg$Q2_21_TEXT,
                        "PDRW3D3_OptOut" = CaseProg$Q2_22_TEXT,
                        "LENAW3D1Log_OptOut" = CaseProg$Q2_23_TEXT,
                        "LENAW3D2Log_OptOut" = CaseProg$Q2_24_TEXT,
                        "DropOutStage" = CaseProg$Q9,
                        "DropOutDate" = CaseProg$Q10)
#Remove rows without cases
library(dplyr)
CaseProg <- CaseProg %>% slice(-c(1,2))

EnrollmentConsents <- full_join(Consents1,Consents2)
EnrollmentConsents <- full_join(EnrollmentConsents,LENATracker)
EnrollmentConsents <- full_join(EnrollmentConsents,CaseProg)
library(dplyr)
Enrollment <- full_join(EnrollmentConsents, Enrollment)
ConsentCompletion <- Enrollment$ConsentCompletion <- ifelse(Enrollment$Informed.Consent > "2020-07-01", "Complete", "Incomplete")
```

```{r SEAL Counts by Wave, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))

ConsentComp<- (ConsentCompletion == "Complete")
ConsentComp <- length(grep("TRUE", ConsentComp))

PostConsentComp<- (ConsentCompletion == "Complete" & SubInfoCompletion == "Complete")
PostConsentComp<- length(grep("TRUE", PostConsentComp))

PostConsentInProg<- (ConsentCompletion == "Complete" & is.na(SubInfoCompletion))
PostConsentInProg <- length(grep("TRUE", PostConsentInProg))

Wv1Comp<- (ConsentCompletion == "Complete" & LENAD2DiaryCompletion == "Complete")
Wv1Comp <- length(grep("TRUE", Wv1Comp))

Wv1InProg<- (is.na(LENAD2DiaryCompletion) & ConsentCompletion == "Complete")
Wv1InProg <- length(grep("TRUE", Wv1InProg))


IntvComp<- (Survey3Completion == "Complete" & LENAD2DiaryCompletion == "Complete")
IntvComp <- length(grep("TRUE", IntvComp))

IntvInProg<- (is.na(Survey3Completion) & LENAD2DiaryCompletion == "Complete")
IntvInProg <- length(grep("TRUE", IntvInProg))

Wv2Comp<- (LENAD4DiaryCompletion == "Complete")
Wv2Comp <- length(grep("TRUE", Wv2Comp))

Wv2InProg<- (is.na(LENAD4DiaryCompletion) & Survey3Completion == "Complete")
Wv2InProg <- length(grep("TRUE", Wv2InProg))

TotalInProg<- sum(PostConsentInProg,Wv1InProg,Wv2InProg, Wv2InProg)
```
<center>

<div class="btn-group btn-group-justified">
  <div class="btn-group">
<a href="#" class="btn btn-default">**Post-Consent Complete**<br>`r PostConsentComp`</a>
  </div>
  
  <div class="btn-group">
<a href="#" class="btn btn-default">**Post-Consent In Progress**<br>`r PostConsentInProg`</a>
  </div>
  
  <div class="btn-group">
<a href="#" class="btn btn-default">**Post-Consent Drop-Outs**<br>TBD</a>
  </div>
  
</div>
  
<div class="btn-group btn-group-justified">
 <div class="btn-group">
<a href="#" class="btn btn-primary">**Wave 1 Complete**<br>`r Wv1Comp`</a>
  </div>
  
  <div class="btn-group">
<a href="#" class="btn btn-primary">**Wave 1 In Progress**<br>`r Wv1InProg`</a>
  </div>
  
  <div class="btn-group">
<a href="#" class="btn btn-primary">**Wave 1 Drop-Outs**<br>TBD</a>
  </div>
  
</div>

<div class="btn-group btn-group-justified">
 <div class="btn-group">
<a href="#" class="btn btn-success">**Intervention Complete**<br>`r IntvComp`</a>
  </div>
 <div class="btn-group">
<a href="#" class="btn btn-success">**Intervention In Progress**<br>`r IntvInProg`</a>
  </div>
  
  <div class="btn-group">
<a href="#" class="btn btn-success">**Intervention Drop-Outs**<br>TBD</a>
  </div>
  
</div>

<div class="btn-group btn-group-justified">
 <div class="btn-group">
<a href="#" class="btn btn-info">**Wave 2 Complete**<br>`r Wv2Comp`</a>
  </div>
 <div class="btn-group">
<a href="#" class="btn btn-info">**Wave 2 In Progress**<br>`r Wv2InProg`</a>
  </div>
  
  <div class="btn-group">
<a href="#" class="btn btn-info">**Wave 2 Drop-Outs**<br>TBD</a>
  </div>
  
</div>

<div class="btn-group btn-group-justified">
 <div class="btn-group">
<a href="#" class="btn btn-warning">**Wave 3 Complete**<br>TBD</a>
  </div>
 <div class="btn-group">
<a href="#" class="btn btn-warning">**Wave 3 In Progress**<br>TBD</a>
  </div>
  
  <div class="btn-group">
<a href="#" class="btn btn-warning">**Wave 3 Drop-Outs**<br>TBD</a>
  </div>
  
</div>

<div class="btn-group btn-group-justified">
 <div class="btn-group">
<a href="#" class="btn btn-danger">**Total Complete with Study**<br>TBD</a>
  </div>
 <div class="btn-group">
<a href="#" class="btn btn-danger">**Total In Progress**<br>`r TotalInProg`</a>
  </div>
  
  <div class="btn-group">
<a href="#" class="btn btn-danger">**Total Drop-Outs**<br>TBD</a>
  </div>
  
</div>

</div>
<br>
<br>
<center>

  
<center>
**Wave 1 and 2 Participant Completion **  
This chart shows the combination of completions for the dyads across Waves 1 and 2.  
<center>

```{r SEAL Wave Progression, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))


Wave_Progression <- Enrollment %>%
  dplyr::mutate(month = format(SubInfoActual, "%m")) %>%
  dplyr::group_by(Survey1Completion, Survey2Completion, PDR2Completion, PDR3Completion, LENAD1DiaryCompletion, LENAD2DiaryCompletion, Survey3Completion, Survey4Completion, PDR5Completion, PDR6Completion, LENAD3DiaryCompletion, LENAD4DiaryCompletion) %>%
  dplyr::summarize(Count = n())
 
library(kableExtra)
  kable(Wave_Progression,
        col.names = c("Survey 1","Survey 2","PDR 2", "PDR 3", "LENA D1 Diary", "LENA D2 Diary", "Survey 3","Survey 4","PDR 5", "PDR 6", "LENA D3 Diary", "LENA D4 Diary","Number Complete")) %>%
        kable_minimal()

```


```{r SEAL Test Counts 1, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))
#Counts of Variables
#Survey1Start <- as.character(masterfile$Survey1Start)
#Survey1Delinquent <- sum(is.na(masterfile$Survey1Start))
#Survey1Complete <- length(Survey1Start) - Survey1Delinquent
#Survey2Start <- as.character(masterfile$Survey2Start)
#Survey2Delinquent <- sum(is.na(masterfile$Survey2Start))
#Survey2Complete <- length(Survey2Start) - Survey2Delinquent
#PDR2Start <- as.character(masterfile$PDR2Start)
#PDR2Delinquent <- sum(is.na(masterfile$PDR2Start))
#PDR2Complete <- length(PDR2Start) - Survey2Delinquent
#PDR3Start <- as.character(masterfile$PDR3Start)
#PDR3Delinquent <- sum(is.na(masterfile$PDR3Start))
#PDR3Complete <- length(PDR3Start) - PDR3Delinquent
#LENAD1Start <- as.character(masterfile$rSEAL.C1.LDL.003)
#LENAD1Delinquent <- sum(is.na(masterfile$rSEAL.C1.LDL.003))
#LENAD1Complete <- length(LENAD1Start) - LENAD1Delinquent
#LENAD2Start <- as.character(masterfile$rSEAL.C1.LDL.029)
#LENAD2Delinquent <- sum(is.na(masterfile$rSEAL.C1.LDL.029))
#LENAD2Complete <- length(LENAD2Start) - LENAD2Delinquent
#Survey3Start <- as.character(masterfile$Survey3Start)
#Survey3Delinquent <- sum(is.na(masterfile$Survey3Start))
#Survey3Complete <- length(Survey3Start) - Survey3Delinquent
#Survey4Start <- as.character(masterfile$Survey4Start)
#Survey4Delinquent <- sum(is.na(masterfile$Survey4Start))
#Survey4Complete <- length(Survey4Start) - Survey4Delinquent
#PDR5Start <- as.character(masterfile$PDR5Start)
#PDR5Delinquent <- sum(is.na(masterfile$PDR5Start))
#PDR5Complete <- length(PDR5Start) - Survey4Delinquent
#PDR6Start <- as.character(masterfile$PDR6Start)
#PDR6Delinquent <- sum(is.na(masterfile$PDR6Start))
#PDR6Complete <- length(PDR6Start) - PDR6Delinquent
#LENAD3Start <- as.character(masterfile$rSEAL.C2.LDL.003)
#LENAD3Delinquent <- sum(is.na(masterfile$rSEAL.C2.LDL.003))
#LENAD3Complete <- length(LENAD3Start) - LENAD3Delinquent
#LENAD4Start <- as.character(masterfile$rSEAL.C2.LDL.029)
#LENAD4Delinquent <- sum(is.na(masterfile$rSEAL.C2.LDL.029))
#LENAD4Complete <- length(LENAD4Start) - LENAD4Delinquent

# Create data
#data <- data.frame(
 # Wave1=c("Survey 1","Survey 2","PDR 2","PDR 3","LENA Day 1 Diary", "LENA Day 2 Diary", "Survey 3","Survey 4","PDR 5","PDR 6","LENA Day 3 Diary", "LENA Day 4 Diary") ,  
  #value=c(Survey1Complete,Survey2Complete,PDR2Complete,PDR3Complete,LENAD1Complete, #LENAD2Complete,Survey3Complete,Survey4Complete,PDR5Complete,PDR6Complete,LENAD3Complete, #LENAD4Complete)
 # )
#tbl <- kbl(data, col.names = c("Instrument","Counts")) %>%
 # kable_styling( bootstrap_options = "striped", full_width = F, position = "float_left", #font_size = 16)

```
<center>
**Participant Progression **  
This chart shows the number of participants complete with each survey instrument across Wave 1 and 2. This does not currently capture those who have dropped out (but can/will). 
<center>
::: {}
```{r SEAL Wave 1 Progression, echo = FALSE, fig.width=10, fig.height=4, message=FALSE, warning=FALSE}
Enrollment$Surv1CompletionTime<- round(difftime(Enrollment$Survey1Actual,Enrollment$SubInfoActual, units = c("days"),1))
today <- as.Date(Sys.time())
start <- as.Date("2020-07-01")
Test0 <- today - Enrollment$Informed.Consent
Test <- today - Enrollment$SubInfoActual
Test1 <- today - Enrollment$Survey1Actual
Test2 <- today - Enrollment$Survey2Actual
Test3 <- today - Enrollment$PDR2Actual
Test4 <- today - Enrollment$LENA1Expected
Test5 <- today - Enrollment$LENA2Expected
Test6 <- today - Enrollment$LENAD2DiaryActual
Test7 <- today - Enrollment$Survey3Actual
Test8 <- today - Enrollment$Survey4Actual
Test9 <- today - Enrollment$PDR5Actual
Test10 <- today - Enrollment$PDR6Actual
Test11 <- today - Enrollment$LENAD3DiaryActual
Enrollment1 <- Enrollment %>%
      select(RSID:Surv1CompletionTime) %>%
      mutate(
      ConsentStatus = case_when(is.na(Enrollment$Informed.Consent) ~ "Delinquent",
      Enrollment$Informed.Consent > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )

Enrollment1.1 <- Enrollment1 %>%
        select(RSID:ConsentStatus) %>%
      mutate(
      PostConsentStatus = case_when(
      Test0 > 7 & is.na(SubInfoActual) ~ "Delinquent",
      Test0 <= 7 & Test0 >= 3 & is.na(SubInfoActual) ~ "Warning",
      Test0 < 3 & is.na(SubInfoActual) ~ "On-Track",
      DropOutDate > start & is.na(SubInfoActual) ~ "Opt-Out",
      Survey1Actual > start & is.na(SubInfoActual) ~ "Delinquent",
      Survey2Actual > start & is.na(SubInfoActual) ~ "Delinquent",
      PDR2Actual > start & is.na(SubInfoActual) ~ "Delinquent",
      PDR3Actual > start & is.na(SubInfoActual) ~ "Delinquent",
      LENAD1DiaryActual > start & is.na(SubInfoActual) ~ "Delinquent",
      LENAD2DiaryActual > start & is.na(SubInfoActual) ~ "Delinquent",
      SubInfoActual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )

Enrollment2 <- Enrollment1.1 %>%
      select(RSID:PostConsentStatus) %>%
      mutate(
      Surv1Status = case_when(
      Test > 7 & is.na(Survey1Actual) ~ "Delinquent",
      Test <= 7 & Test >= 3 & is.na(Survey1Actual) ~ "Warning",
      Test < 3 & is.na(Survey1Actual) ~ "On-Track",
      DropOutDate > start & is.na(Survey1Actual) ~ "Opt-Out",
      Survey1_OptOut > start  ~ "Opt-Out",
      Survey2Actual > start & is.na(Survey1Actual) ~ "Delinquent",
      PDR2Actual > start & is.na(Survey1Actual) ~ "Delinquent",
      PDR3Actual > start & is.na(Survey1Actual) ~ "Delinquent",
      LENAD1DiaryActual > start & is.na(Survey1Actual) ~ "Delinquent",
      LENAD2DiaryActual > start & is.na(Survey1Actual) ~ "Delinquent",
      Survey1Actual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )
Enrollment3 <- Enrollment2%>%
      select(RSID:Surv1Status) %>%
      mutate(
      Surv2Status = case_when(
      Test1 > 7 & is.na(Survey2Actual) ~ "Delinquent",
      Test1 <= 7 & Test1 >= 3 & is.na(Survey2Actual) ~ "Warning",
      Test1 < 3 & is.na(Survey2Actual) ~ "On-Track",
      DropOutDate > start & is.na(Survey2Actual) ~ "Opt-Out",
      Survey2_OptOut > start  ~ "Opt-Out",
      PDR2Actual > start & is.na(Survey2Actual) ~ "Delinquent",
      PDR3Actual > start & is.na(Survey2Actual) ~ "Delinquent",
      LENAD1DiaryActual > start & is.na(Survey2Actual) ~ "Delinquent",
      LENAD2DiaryActual > start & is.na(Survey2Actual) ~ "Delinquent",
      Survey2Actual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )
Enrollment4 <- Enrollment3%>%
      select(RSID:Surv2Status) %>%
      mutate(
      PDR2Status = case_when(
      Test2 > 3 & is.na(PDR2Actual) ~ "Delinquent",
      Test2 <= 3 & Test2 >= 1 & is.na(PDR2Actual) ~ "Warning",
      Test2 < 1 & is.na(PDR2Actual) ~ "On-Track",
      DropOutDate > start & is.na(PDR2Actual) ~ "Opt-Out",
      PDRW1D2_OptOut > start  ~ "Opt-Out",
      PDR3Actual > start & is.na(PDR2Actual) ~ "Delinquent",
      LENAD1DiaryActual > start & is.na(PDR2Actual) ~ "Delinquent",
      LENAD2DiaryActual > start & is.na(PDR2Actual) ~ "Delinquent",
      PDR2Actual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )
Enrollment5 <- Enrollment4%>%
      select(RSID:PDR2Status) %>%
      mutate(
      PDR3Status = case_when(
      Test3 > 3 & is.na(PDR3Actual) ~ "Delinquent",
      Test3 <= 3 & Test3 >= 1 & is.na(PDR3Actual) ~ "Warning",
      Test3 < 1 & is.na(PDR3Actual) ~ "On-Track",
      DropOutDate > start & is.na(PDR3Actual) ~ "Opt-Out",
      PDRW1D3_OptOut > start  ~ "Opt-Out",
      LENAD1DiaryActual > start & is.na(PDR3Actual) ~ "Delinquent",
      LENAD2DiaryActual > start & is.na(PDR3Actual) ~ "Delinquent",
      PDR3Actual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )
Enrollment6 <- Enrollment5%>%
      select(RSID:PDR3Status) %>%
      mutate(
      LENAD1DiaryStatus = case_when(
      Test4 > 4 & is.na(LENAD1DiaryActual) ~ "Delinquent",
      Test4 <= 4 & Test4 >= 2 & is.na(LENAD1DiaryActual) ~ "Warning",
      Test4 < 2 & is.na(LENAD1DiaryActual) ~ "On-Track",
      DropOutDate > start & is.na(LENAD1DiaryActual) ~ "Opt-Out",
      LENAW1D1Log_OptOut > start  ~ "Opt-Out",
      PDRW1D3_OptOut > start  ~ "Opt-Out",
      LENAD2DiaryActual > start & is.na(LENAD1DiaryActual) ~ "Delinquent",
      LENAD1DiaryActual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )
Enrollment7 <- Enrollment6%>%
      select(RSID:LENAD1DiaryStatus) %>%
      mutate(
      LENAD2DiaryStatus = case_when(
      Test5 > 3 & is.na(LENAD2DiaryActual) ~ "Delinquent",
      Test5 <= 3 & Test5 >= 1 & is.na(LENAD2DiaryActual) ~ "Warning",
      Test5 < 1 & is.na(LENAD2DiaryActual) ~ "On-Track",
      DropOutDate > start & is.na(LENAD2DiaryActual) ~ "Opt-Out",
      LENAW1D2Log_OptOut > start  ~ "Opt-Out",
      Survey3Actual > start & is.na(LENAD2DiaryActual) ~ "Delinquent",
      Survey4Actual > start & is.na(LENAD2DiaryActual) ~ "Delinquent",
      PDR5Actual > start & is.na(LENAD2DiaryActual) ~ "Delinquent",
      PDR6Actual > start & is.na(LENAD2DiaryActual) ~ "Delinquent",
      LENAD3DiaryActual > start & is.na(LENAD2DiaryActual) ~ "Delinquent",
      LENAD4DiaryActual > start & is.na(LENAD2DiaryActual) ~ "Delinquent",
      LENAD2DiaryActual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )

Enrollment8 <- Enrollment7%>%
      select(RSID:LENAD2DiaryStatus) %>%
      mutate(
      Surv3Status = case_when(
      Test6 > 90 & is.na(Survey3Actual) ~ "Delinquent",
      Test6 <= 90 & Test6 >= 70 & is.na(Survey3Actual) ~ "Warning",
      Test6 < 70 & is.na(Survey3Actual) ~ "On-Track",
      DropOutDate > start & is.na(Survey3Actual) ~ "Opt-Out",
      Survey3_OptOut > start  ~ "Opt-Out",
      Survey4Actual > start & is.na(Survey3Actual) ~ "Delinquent",
      PDR5Actual > start & is.na(Survey3Actual) ~ "Delinquent",
      PDR6Actual > start & is.na(Survey3Actual) ~ "Delinquent",
      LENAD3DiaryActual > start & is.na(Survey3Actual) ~ "Delinquent",
      LENAD4DiaryActual > start & is.na(Survey3Actual) ~ "Delinquent",
      Survey3Actual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )

Enrollment9 <- Enrollment8%>%
      select(RSID:Surv3Status) %>%
      mutate(
      Surv4Status = case_when(
      Test7 > 7 & is.na(Survey4Actual) ~ "Delinquent",
      Test7 <= 7 & Test7 >= 3 & is.na(Survey4Actual) ~ "Warning",
      Test7 < 3 & is.na(Survey4Actual) ~ "On-Track",
      DropOutDate > start & is.na(Survey4Actual) ~ "Opt-Out",
      Survey4_OptOut > start  ~ "Opt-Out",
      PDR5Actual > start & is.na(Survey4Actual) ~ "Delinquent",
      PDR6Actual > start & is.na(Survey4Actual) ~ "Delinquent",
      LENAD3DiaryActual > start & is.na(Survey4Actual) ~ "Delinquent",
      LENAD4DiaryActual > start & is.na(Survey4Actual) ~ "Delinquent",
      Survey4Actual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )

Enrollment10 <- Enrollment9%>%
      select(RSID:Surv4Status) %>%
      mutate(
      PDR5Status = case_when(
      Test8 > 3 & is.na(PDR5Actual) ~ "Delinquent",
      Test8 <= 3 & Test8 >= 1 & is.na(PDR5Actual) ~ "Warning",
      Test8 < 1 & is.na(PDR5Actual) ~ "On-Track",
      DropOutDate > start & is.na(PDR5Actual) ~ "Opt-Out",
      PDRW2D2_OptOut > start  ~ "Opt-Out",
      PDR6Actual > start & is.na(PDR5Actual) ~ "Delinquent",
      LENAD3DiaryActual > start & is.na(PDR5Actual) ~ "Delinquent",
      LENAD4DiaryActual > start & is.na(PDR5Actual) ~ "Delinquent",
      PDR5Actual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )

Enrollment11 <- Enrollment10%>%
      select(RSID:PDR5Status) %>%
      mutate(
      PDR6Status = case_when(
      Test9 > 3 & is.na(PDR6Actual) ~ "Delinquent",
      Test9 <= 3 & Test9 >= 1 & is.na(PDR6Actual) ~ "Warning",
      Test9 < 1 & is.na(PDR6Actual) ~ "On-Track",
      DropOutDate > start & is.na(PDR6Actual) ~ "Opt-Out",
      PDRW2D3_OptOut > start  ~ "Opt-Out",
      LENAD3DiaryActual > start & is.na(PDR6Actual) ~ "Delinquent",
      LENAD4DiaryActual > start & is.na(PDR6Actual) ~ "Delinquent",
      PDR6Actual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )

Enrollment12 <- Enrollment11%>%
      select(RSID:PDR6Status) %>%
      mutate(
      LENAD3DiaryStatus = case_when(
      Test10 > 4 & is.na(LENAD3DiaryActual) ~ "Delinquent",
      Test10 <= 4 & Test10 >= 2 & is.na(LENAD3DiaryActual) ~ "Warning",
      Test10 < 2 & is.na(LENAD3DiaryActual) ~ "On-Track",
      DropOutDate > start & is.na(LENAD3DiaryActual) ~ "Opt-Out",
      LENAW2D1Log_OptOut > start  ~ "Opt-Out",
      LENAD4DiaryActual > start & is.na(LENAD3DiaryActual) ~ "Delinquent",
      LENAD3DiaryActual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )

Enrollment13 <- Enrollment12%>%
      select(RSID:LENAD3DiaryStatus) %>%
      mutate(
      LENAD4DiaryStatus = case_when(
      Test11 > 3 & is.na(LENAD4DiaryActual) ~ "Delinquent",
      Test11 <= 3 & Test >= 1 & is.na(LENAD4DiaryActual) ~ "Warning",
      Test11 < 1 & is.na(LENAD4DiaryActual) ~ "On-Track",
      DropOutDate > start & is.na(LENAD4DiaryActual) ~ "Opt-Out",
      LENAW2D2Log_OptOut > start  ~ "Opt-Out",
      LENAD4DiaryActual > start       ~ "Complete",
      TRUE                      ~ "NA"
      )
     )
Enrollment14 <- gather(Enrollment13, "Instrument", "Status", ConsentStatus, PostConsentStatus, Surv1Status, Surv2Status,PDR2Status, PDR3Status,LENAD1DiaryStatus,LENAD2DiaryStatus,Surv3Status, Surv4Status,PDR5Status, PDR6Status,LENAD3DiaryStatus,LENAD4DiaryStatus)
library(ggplot2) #load ggplot2 library
Enrollment14$Status <- factor(Enrollment14$Status, levels = c("Complete", "On-Track", "NA", "Warning",  "Delinquent", "Opt-Out"))
Enrollment14$Status <- forcats::fct_relevel(Enrollment14$Status, "NA", after = Inf)
Enrollment14$Status <- forcats::fct_relevel(Enrollment14$Status, "Delinquent", after = 4)
Enrollment14$Status <- forcats::fct_relevel(Enrollment14$Status, "Warning", after = 3)
#Enrollment14$Status <- forcats::fct_relevel(Enrollment14$Status, "Opt-Out", after = 2)
Enrollment14$Cases <- factor(Enrollment14$RSID) # Create a categorical variable
Enrollment14$Instrument <- factor(Enrollment14$Instrument, levels = c("ConsentStatus", "PostConsentStatus", "Surv1Status","Surv2Status","PDR2Status","PDR3Status", "LENAD1DiaryStatus","LENAD2DiaryStatus", "Surv3Status","Surv4Status","PDR5Status","PDR6Status", "LENAD3DiaryStatus","LENAD4DiaryStatus")) # Create categorical variable

p <- ggplot(data = Enrollment14, aes(x=Instrument, fill= forcats::fct_rev(Status))) + geom_bar() + # Creates stacked bar chart
scale_x_discrete(labels=c("Consent","PostConsentStatus", "Survey 1", "Survey 2", "PDR2", "PDR3", "LENA D1 Diary", "LENA D2 Diary", "Survey 3", "Survey 4", "PDR5", "PDR6", "LENA D3 Diary", "LENA D4 Diary")) +
scale_fill_manual(values = c("#bdbdbd","#e31a1c", "#ffff99","#737373","#1f78b4", "#33a02c" ), labels = c("NA", "Delinquent","Warning", "Opt-Out","On-Track", "Complete")) #Manually assigns colors
p <- p + xlab("Instrument") + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + labs(fill = "Statuses") 
 # Adds title and labels
p
```

```{r SEAL Wave 1 Progression Table, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
Wave1 <- table(Enrollment14$Instrument, Enrollment14$Status, dnn=c("Instrument", "Status"))
library(kableExtra)
rownames(Wave1) = c("Consent", "Post Consent", "Survey 1", "Survey 2", "PDR2", "PDR3", "LENA D1 Diary", "LENA D2 Diary", "Survey 3", "Survey 4", "PDR5", "PDR6", "LENA D3 Diary", "LENA D4 Diary")
Wave1Counts <- kable(Wave1,
        col.names = c("Complete","On-Track", "Opt-Out","Warning","Delinquent", "NA")) %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

Wave1Counts
```
:::