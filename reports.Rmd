---
title: "Reports"
author: 
date: "Last Updated: 12/16/2020"
output: 
  html_document:
    theme: flatly
    css: columns.css
---

```{r load-packages, echo=FALSE, warning=FALSE, include=FALSE, cache=FALSE}

library(magrittr)
library(codified)
library(rlang)
library(tibble)
library(tidyr)
library(checkmate)
library(testthat)
library(cowplot)
library(readxl)
library(knitr)
library(formattable)
library(ggpubr)
library(frequency)
library(plotly)
library(emmeans)
library(kableExtra)
library(papaja)
library(kableExtra)
library(dplyr)
library(RColorBrewer)
library(tidyverse)
library(ggformula)
library(lubridate)
library(plyr)
library(RColorBrewer)
library(ggplot2)
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)
library(reshape2)
library(skimr)
library(here)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format = "html", knitr.kable.NA = '') 
```


```{r Read in Files, echo = FALSE, warning=FALSE, message=FALSE}
#Enrollment Data
Enrollment <- data.frame(read.csv(file = '/Volumes/psy-ctn/psy-ctn/SNAPLab/SNAP Projects/SEAL/Data Management/Enrollment_Table/Enrollment_Table15DEC2020_Rversion.csv'))

#SEAL Numbers Data
Numbers <- data.frame(read_xlsx('/Volumes/psy-ctn/psy-ctn/SNAPLab/SNAP Projects/SEAL/Data Management/Enrollment_Table/SEAL_Numbers_16DEC2020.xlsx','Current_Data'))

```


<center>
**Counts of dyads for both remote and in-person SEAL through November 2020.** 
<center>

:::: {style="display: flex;"}

::: {}
```{r SEAL Conditions Count, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))

Condition <- as.numeric(as.character(Numbers$Condition))

Conditions <- Numbers %>%
  dplyr::group_by(Condition, Consent_YR) %>%
  dplyr::summarize(Count = n())

  kable(Conditions,
        col.names = c("Condition","Year","Count")) %>%
        kable_minimal()

```
:::

::: {}
```{r SEAL Conditions Plot, echo = FALSE, fig.width=5, fig.height=4,, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))

ConditionsPlot <- ggplot(Conditions, aes(x = Consent_YR, y = Count, fill = Condition)) +
  geom_col() +
  facet_wrap(~Condition)

ConditionsPlot + labs(x = "Year")
```
:::

::::

<center>
**Counts of Intervention Start Dates for SEAL through November 2020.** 
<center>

:::: {style="display: flex;"}

::: {}

```{r SEAL Interventions Count, echo = FALSE, fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))

Condition <- as.numeric(as.character(Numbers$Condition))

IntvStart <- Numbers %>%
  dplyr::group_by(Condition, IntvStartMonth) %>%
  dplyr::summarize(Count = n())

  kable(IntvStart,
        col.names = c("Condition","Month/Year","Count")) %>%
        kable_minimal()

```
:::

::: {}
```{r SEAL Interventions Plot, echo = FALSE, fig.width=5, fig.height=4,, message=FALSE, warning=FALSE}
par(mar = c(4, 4, .2, .1))

ConditionsPlot <- ggplot(IntvStart, aes(x = IntvStartMonth, y = Count, fill = Condition)) +
  geom_col() +
  facet_wrap(~Condition)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1))

ConditionsPlot + labs(x = "Year")
```
:::

::::
```{r NIH Table, echo = FALSE, message=FALSE, warning=FALSE,}

library(magrittr)
path <- system.file("/Volumes/psy-ctn/psy-ctn/SNAPLab/SNAP Projects/SEAL/Data Management/Enrollment_Table/Enrollment_Table15DEC2020_Rversion.csv", package="codified")
col_types <- readr::cols_only(
  record_id = readr::col_integer(),
  name_last = readr::col_character(),
  dob       = readr::col_date(format = ""),
  gender    = readr::col_integer(),
  race      = readr::col_integer(),
  ethnicity = readr::col_integer()
)
ds <- readr::read_csv("/Volumes/psy-ctn/psy-ctn/SNAPLab/SNAP Projects/SEAL/Data Management/Enrollment_Table/Enrollment_Table15DEC2020_Rversion.csv") %>%
  dplyr::mutate(
    gender     = as.character(gender),
    race       = as.character(race),
    ethnicity  = as.character(ethnicity)
  )
#ds %>% 
  #head(10) %>% 
  #knitr::kable(caption = "Observed Dataset (first ten rows)")
```

```{r NIH Table Gender Mapping, echo = FALSE, message=FALSE, warning=FALSE,}
ds_lu_gender <- tibble::tribble(
  ~input,   ~displayed            ,
  "0"   ,  "Female"               , 
  "1"   ,  "Male"                 ,
  "U"   ,  "Unknown/Not Reported"
)
#knitr::kable(ds_lu_gender, caption = "Gender Mapping")
```

```{r NIH Table Race Mapping, echo = FALSE, message=FALSE, warning=FALSE,}
ds_lu_race <- tibble::tribble(
  ~input , ~displayed                                   ,
  "1"    , "American Indian/Alaska Native"              ,
  "2"    , "Asian"                                      ,
  "3"    , "Native Hawaiian or Other Pacific Islander"  ,
  "4"    , "Black or African American"                  ,
  "5"    , "White"                                      ,
  "M"    , "More than One Race"                         ,
  "6"    , "Unknown or Not Reported"
)
#knitr::kable(ds_lu_race, caption = "Race Mapping")
```

```{r NIH Table Ethnicity Mapping, echo = FALSE, message=FALSE, warning=FALSE,}
ds_lu_ethnicity <- tibble::tribble(
  ~input,   ~displayed                      ,
  "2"   ,  "Not Hispanic or Latino"         ,
  "1"   ,  "Hispanic or Latino"             ,
  "0"   ,  "Unknown/Not Reported Ethnicity"
)
#knitr::kable(ds_lu_ethnicity, caption = "Ethnicity Mapping")
```

```{r NIH Table Mapped to Observed, echo = FALSE, message=FALSE, warning=FALSE,}
ds_summary_long <- codified::table_nih_enrollment(
  d              = ds,
  d_lu_gender    = ds_lu_gender,
  d_lu_race      = ds_lu_race,
  d_lu_ethnicity = ds_lu_ethnicity
)

#knitr::kable(ds_summary_long, caption = "Counts of Each Subgroup")
```

Enrollment Table current as of November 2020. Includes dyads (not just caregivers), and combines the in-person and remote SEAL.

```{r NIH Table Conform to Cosmetics, echo = FALSE, message=FALSE, warning=FALSE}
codified::table_nih_enrollment_pretty(
  d              = ds,
  d_lu_gender    = ds_lu_gender,
  d_lu_race      = ds_lu_race,
  d_lu_ethnicity = ds_lu_ethnicity
)
```
